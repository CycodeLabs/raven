# Exploiting Download Action in Workflows with Missing "path" Parameter

> **Note**: Read more about this vulnerability here [Cycode Blog Post](https://cycode.com/blog/analyzing-the-vulnerability-that-could-have-compromised-microsoft-365-users/). Read the blog post to learn more. 

## The Problem

Due to the limitations in native GitHub actions for sharing artifacts across different workflows, developers often resort to custom actions and APIs. One such widely-used custom action is `dawidd6/action-download-artifact`, which currently has over 12,000 dependent repositories.

This custom action and the underlying GitHub API for downloading artifacts didn't discriminate between artifacts created by the base repository and those from a forked repository. This oversight could lead to a workflow to download and process poisoned artifacts, introducing vulnerabilities into the software supply chain.

Without specifying the `path` parameter to indicate where the action should extract the artifact, the action will default to extracting it into the current working directory. This can overwrite original files in the repository and may lead to malicious activity on the build system, posing a risk of a significant supply chain attack.

Github updated its API for GetArtifact and ListArtifacts endpoints to provide more information to help developers differentiate between trusted and untrusted artifacts.


### In Simple Terms

An attacker can fork a repository, create a malicious artifact, and then inject this artifact into the original repository's workflow. The workflow who downloads the artifact, in turn, would unknowingly use the tainted artifact.

## References
- [From Default to Secure: Analyzing the Vulnerability that Could Have Compromised Microsoft 365 Users](https://cycode.com/blog/analyzing-the-vulnerability-that-could-have-compromised-microsoft-365-users/).
- [Novel Pipeline Vulnerability Discovered; Rust  Found Vulnerable](https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust).

## Real-World Examples

### tiangolo/fastapi - 64k ⭐️
* **Description**: Unsafe handling of artifacts download and extract the artifact into the current working directory.
* **Fix Commit Link**: [9efab1bd96ef061edf1753626573a0a2be1eef09](github.com/tiangolo/fastapi/commit/9efab1bd96ef061edf1753626573a0a2be1eef09)
* **Remediation**: Created a specific directory for uploading and extracting artifacts, `site`.

### microsoft/fluentui - 16k ⭐️
* **Description**: Unsafe handling of artifacts within the build process, leading to code execution on the build system and a potentially significant supply chain attack that would deliver malware to all Microsoft 365 users.
* **Fix Commit Link**: [2ea6195152131766641311ee5604e746b578d8e7](https://github.com/microsoft/fluentui/commit/2ea6195152131766641311ee5604e746b578d8e7)
* **Remediation**: Removed the workflow.


### tiangolo/sqlmodel - 11k ⭐️
* **Description**: Unsafe handling of artifacts download and extract the artifact into the current working directory.
* **Fix Commit Link**: [2ea6195152131766641311ee5604e746b578d8e7](https://github.com/tiangolo/sqlmodel/commit/cf36b2d9baccf527bc61071850f102e2cd8bf6bf)
* **Remediation**: Created a specific directory for uploading and extracting artifact, `site`.
  
## Query

``` cypher
MATCH p=(w1:Workflow)-->(w2:Workflow)-[*]->(s:Step)-->(ca:CompositeAction) 
WHERE (
        "pull_request" in w1.trigger OR
        "pull_request_target" in w1.trigger OR
        "issue_comment" in w1.trigger OR
        "issues" in w1.trigger
    ) AND (
        ca.path = "dawidd6/action-download-artifact"
    ) AND (
        not ANY(param IN s.with WHERE 
            (
                param contains "path"
            )
        )
    ) AND
    EXISTS {
            (w2)-[*]->(caTmp:CompositeAction)
            WHERE caTmp.path = "actions/checkout"
}
RETURN DISTINCT w1.url, w2.url;
```

> **Note**: According to the release documentation, in version 2.28.0 of `dawidd6/action-download-artifact`, the action will ignore forks when downloading artifacts.